version: '3.8'

services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: plagiarism-es
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q 'green\\|yellow'"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Ollama - uncomment if you want to run Ollama in Docker
  # Note: For GPU support, you need nvidia-docker
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: plagiarism-ollama
  #   ports:
  #     - "11434:11434"
  #   volumes:
  #     - ollama_data:/root/.ollama
  #   # For GPU support, uncomment:
  #   # deploy:
  #   #   resources:
  #   #     reservations:
  #   #       devices:
  #   #         - driver: nvidia
  #   #           count: 1
  #   #           capabilities: [gpu]

  plagiarism-service:
    # image: thaily/plagiarism:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: plagiarism-service
    ports:
      - "${GRPC_PORT:-50057}:${GRPC_PORT:-50057}"
      - "${METRICS_PORT:-9107}:${METRICS_PORT:-9107}"
    environment:
      # Elasticsearch
      - ES_HOST=${ES_HOST:-172.17.0.1}
      - ES_PORT=${ES_PORT:-10010}
      - ES_USER=${ES_USER:-thaily}
      - ES_PASSWORD=${ES_PASSWORD:-Th@i2004}
      - ES_SCHEME=${ES_SCHEME:-http}
      - ES_INDEX=${ES_INDEX:-plagiarism_documents}
      # Analyzer
      - ANALYZER_MODE=${ANALYZER_MODE:-external}
      # Gemini
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-2.0-flash}
      # Ollama
      - OLLAMA_HOST=${OLLAMA_HOST:-http://172.17.0.1:10006}
      # gRPC
      - GRPC_HOST=0.0.0.0
      - GRPC_PORT=${GRPC_PORT:-50057}
      - GRPC_MAX_WORKERS=${GRPC_MAX_WORKERS:-3}
      # TLS - paths inside container
      - GRPC_TLS_ENABLED=${GRPC_TLS_ENABLED:-true}
      - GRPC_CERT_PATH=/app/certs/plagiarism-server.crt
      - GRPC_KEY_PATH=/app/certs/plagiarism-server.key
      - GRPC_CA_PATH=/app/certs/ca.crt
      - GRPC_REQUIRE_CLIENT_CERT=${GRPC_REQUIRE_CLIENT_CERT:-false}
      # MinIO
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-172.17.0.1}
      - MINIO_PORT=${MINIO_PORT:-10005}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-thaily}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-Th@i2004}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-false}
      - MINIO_BUCKET_NAME=${MINIO_BUCKET_NAME:-lvtn}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - METRICS_PORT=${METRICS_PORT:-9107}
    volumes:
      - ./certs:/app/certs:ro
      - ./logs:/app/logs
    # For Linux, use host network to access services on localhost
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Remove depends_on if not using local ES
    # depends_on:
    #   elasticsearch:
    #     condition: service_healthy

volumes:
  es_data:
    driver: local
  # ollama_data:
  #   driver: local
